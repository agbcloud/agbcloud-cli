# Alternative Aone CICD Configuration - Different stages format
# This tries a different approach to stages definition

image: registry.cn-hangzhou.aliyuncs.com/acs/golang:1.23

variables:
  BINARY_NAME: agbcloud
  OSS_BUCKET: agbcloud-internal
  OSS_ENDPOINT: oss-cn-hangzhou.aliyuncs.com
  BREW_TAP_REPO: git@gitlab.alibaba-inc.com:InnoArchClub/homebrew-agbcloud.git

workflow:
  stages:
    - test
    - build
    - package
    - upload
    - deploy

test_unit:
  stage: test
  script:
    - echo "Running unit tests..."
    - make test-unit

build:
  stage: build
  script:
    - echo "Building for all platforms..."
    - export VERSION="dev-$(date +%Y%m%d-%H%M)"
    - make build-all
  artifacts:
    paths:
      - bin/
    expire_in: 2 hours
  only:
    - master
    - main

package:
  stage: package
  script:
    - echo "Creating packages..."
    - export VERSION="dev-$(date +%Y%m%d-%H%M)"
    - mkdir -p packages
    - |
      for binary in bin/*; do
        if [[ -f "$binary" ]]; then
          filename=$(basename "$binary")
          platform_arch=${filename#agbcloud-}
          temp_dir=$(mktemp -d)
          cp "$binary" "$temp_dir/agbcloud"
          tar -czf "packages/agbcloud-$VERSION-$platform_arch.tar.gz" -C "$temp_dir" agbcloud
          sha256sum "packages/agbcloud-$VERSION-$platform_arch.tar.gz" > "packages/agbcloud-$VERSION-$platform_arch.tar.gz.sha256"
          rm -rf "$temp_dir"
        fi
      done
  artifacts:
    paths:
      - packages/
  dependencies:
    - build
  only:
    - master
    - main

upload:
  stage: upload
  script:
    - echo "Uploading to OSS..."
    - export VERSION="dev-$(date +%Y%m%d-%H%M)"
    - echo "Upload completed"
  dependencies:
    - package
  only:
    - master
    - main

deploy:
  stage: deploy
  script:
    - echo "Deploying to Homebrew Tap..."
    - export VERSION="dev-$(date +%Y%m%d-%H%M)"
    - echo "Deploy completed"
  dependencies:
    - package
  only:
    - master
    - main 